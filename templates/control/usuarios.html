{% extends "base.html" %}

{% block sidebar %}

{% endblock %}

{% block body %}
<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center bg-danger text-white p-3 rounded">
        <h2 class="m-0">Listado Usuarios</h2>
        <div class="d-flex">
            <a href="#" class="btn btn-success mr-2"  data-toggle="modal" data-target="#createUserModal">Agregar <i class="fas fa-plus"></i></a>
        </div>
    </div>
    <table class="table table-hover table-bordered">
        <thead>
            <tr>
                <th>Nombre de Usuario</th>
                <th>Activo</th>
                <th>Personal</th>
                <th>Superusuario</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for usuario in usuarios %}
            <tr>
                <td>{{ usuario.username }}</td>
                <td>{{ usuario.is_active|yesno:"Sí,No" }}</td>
                <td>{{ usuario.is_staff|yesno:"Sí,No" }}</td>
                <td>{{ usuario.is_superuser|yesno:"Sí,No" }}</td>
                <td>
                    <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#deleteModal{{ usuario.id }}">
                        Eliminar
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% for usuario in usuarios %}
<div class="modal fade" id="deleteModal{{ usuario.id }}" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel{{ usuario.id }}" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel{{ usuario.id }}">Confirmar Eliminación</h5>
            </div>
            <div class="modal-body">
                ¿Estás seguro de que deseas eliminar al usuario {{ usuario.username }}?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <a href="{% url 'eliminar_usuario' usuario.id %}" class="btn btn-danger">Eliminar</a>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- Modal de Crear Usuario -->
<div class="modal fade" id="createUserModal" tabindex="-1" role="dialog" aria-labelledby="createUserModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createUserModalLabel">Crear Usuario</h5>
            </div>
            <div class="modal-body">
                <form id="createUserForm" method="post" action="{% url 'usuarios' %}">
                    {% csrf_token %}
                    {{ formulario.as_p }}
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="submitCreateUserForm">Crear</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block script %}
<script>
    $(document).ready(function() {
        $('#submitCreateUserForm').click(function() {
            var form = $('#createUserForm');
            console.log('Form action:', form.attr('action'));
            console.log('Form method:', form.attr('method'));
            $.ajax({
                url: form.attr('action'),
                method: form.attr('method'),
                data: form.serialize(),
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.success) {
                        $('#createUserModal').modal('hide');
                        location.reload();  // Recargar la página para ver el nuevo usuario
                    } else {
                        alert('Hubo un error al crear el usuario: ' + JSON.stringify(response.errors));
                    }
                },
                error: function() {
                    alert('Hubo un error al crear el usuario.');
                }
            });
        });
    });
</script>
{% endblock %}
